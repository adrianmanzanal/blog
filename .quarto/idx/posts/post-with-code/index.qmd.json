{"title":"Create map-charts using mapSpain","markdown":{"yaml":{"title":"Create map-charts using mapSpain","author":"Adrian Manzanal","date":"2023-11-21","categories":["news","code","analysis","geolocalitation"],"image":"logo.png"},"headingText":"**The purpose is to create quick map-charts using mapSpain library in R.**","containsRefs":false,"markdown":"\n\n**LetÂ´s go to show our data using maps!**\n\n### 1. mapSpain library\n\nmapSpain is a package that provides spatial sf objects of the administrative boundaries of Spain, including CCAA, provinces and municipalities.\n\nmapSpain also provides a leaflet plugin to be used with the leaflet package, that loads several basemaps of public institutions of Spain, and the ability of downloading and processing static tiles.\n\nFull site with examples and vignettes on https://ropenspain.github.io/mapSpain/\n\nYou can install and activate the library following the instructions:\n\n```{r}\n#| eval: false\n#| output: false\n#| error: false\ninstall.packages(\"mapSpain\", dependencies = TRUE)\n```\n\n```{r}\n#| eval: true\n#| output: false\n#| error: false\nlibrary(mapSpain)\n```\n\n```{r}\n#| eval: false\n#| output: false\n#| error: false\ninstall.packages(\"sf\", dependencies = TRUE)\n```\n\n```{r}\n#| eval: true\n#| output: false\n#| error: false\nlibrary(sf)\n```\n\n### 2. Obtain CCAA Spain Map\n\nWe are going to extract basic Spain map which includes all CCAA. In order to be able\nto represent that data we need to add ggplot library to our project:\n\n```{r}\n#| eval: false\n#| output: false\n#| error: false\ninstall.packages(\"ggplot2\", dependencies = TRUE)\n```\n\n```{r}\n#| eval: true\n#| output: false\n#| error: false\nlibrary(ggplot2)\n```\n\nThe following fucntion (esp-get_ccaa) will generate a data frame that include geometry information for each CCAA:\n\n```{r}\n#| eval: true\n#| output: true\n#| error: true\nspain <- esp_get_ccaa() \n\nggplot() + geom_sf(data=spain)\n\n```\n### 3. Joining data and map-chart\n\n**First of all we are going to upload some data**\n\nInflation data segmented by CCAA will be upload using the basic instruction. This data set has been downloaded from the INE website. It represents the inflation rates during the current year so far. You can choose the KPI that you are interested in, but the data set granularity should include CCAA detail.\n\n```{r}\n#| eval: false\n#| output: false\n#| error: false\ninstall.packages(\"tidyverse\", dependencies = TRUE)\n```\n\n```{r}\n#| eval: true\n#| output: false\n#| error: false\nlibrary(tidyverse)\n```\n\n```{r}\n#| eval: true\n#| output: true\n#| error: true\ninflation_df <- read.csv(\"inflacionccaa.csv\", header = TRUE, sep = \";\", check.names = F)\nglimpse(inflation_df)\n```\n\n**Now we are going to modify data in order to get the right information**\n\nOriginal file contains some many different KPIs that explain prices' variations. We are interested to see differences in annual rates (2021 vs 2022) by CCAA. In addition, CCAA IDs should be codified in order to match with the map-chart IDs.\n\n```{r}\n#| eval: true\n#| output: true\n#| error: true\n\ninflationOK_df <- inflation_df %>% \n  filter(`Tipo de dato` == \"Variacion anual\") %>% \n  filter(`Comunidades y Ciudades Autonomas` != \"Nacional\") %>% \n  mutate(iso2.ccaa.code = case_when(\n    str_detect(`Comunidades y Ciudades Autonomas`, \"01 AndalucIa\") ~ \"ES-AN\",\n    str_detect(`Comunidades y Ciudades Autonomas`, \"02 Aragon\") ~ \"ES-AR\",\n    str_detect(`Comunidades y Ciudades Autonomas`, \"03 Asturias. Principado de\") ~ \"ES-AS\",\n    str_detect(`Comunidades y Ciudades Autonomas`, \"04 Balears. Illes\") ~ \"ES-IB\",\n    str_detect(`Comunidades y Ciudades Autonomas`, \"05 Canarias\") ~ \"ES-CN\",\n    str_detect(`Comunidades y Ciudades Autonomas`, \"06 Cantabria\") ~ \"ES-CB\",\n    str_detect(`Comunidades y Ciudades Autonomas`, \"07 Castilla y Leon\") ~ \"ES-CL\",\n    str_detect(`Comunidades y Ciudades Autonomas`, \"08 Castilla - La Mancha\") ~ \"ES-CM\",\n    str_detect(`Comunidades y Ciudades Autonomas`, \"09 Cataluna\") ~ \"ES-CT\",\n    str_detect(`Comunidades y Ciudades Autonomas`, \"10 Comunitat Valenciana\") ~ \"ES-VC\",\n    str_detect(`Comunidades y Ciudades Autonomas`, \"11 Extremadura\") ~ \"ES-EX\",\n    str_detect(`Comunidades y Ciudades Autonomas`, \"12 Galicia\") ~ \"ES-GA\",\n    str_detect(`Comunidades y Ciudades Autonomas`, \"13 Madrid. Comunidad de\") ~ \"ES-MD\",\n    str_detect(`Comunidades y Ciudades Autonomas`, \"14 Murcia. Region de\") ~ \"ES-MC\",\n    str_detect(`Comunidades y Ciudades Autonomas`, \"15 Navarra. Comunidad Foral de\") ~ \"ES-NC\",\n    str_detect(`Comunidades y Ciudades Autonomas`, \"16 PaIs Vasco\") ~ \"ES-PV\",\n    str_detect(`Comunidades y Ciudades Autonomas`, \"17 Rioja. La\") ~ \"ES-RI\",\n    str_detect(`Comunidades y Ciudades Autonomas`, \"18 Ceuta\") ~ \"ES-CE\",\n    str_detect(`Comunidades y Ciudades Autonomas`, \"19 Melilla\") ~ \"ES-ML\"\n  )) %>% \n  select(-Periodo, -'Comunidades y Ciudades Autonomas')\n\ninflationOK_df \n```\n**Joining Spain Map and Inflation data**\n\nThen we will include inflation data from the csv into spain map table.\n```{r}\n#| eval: true\n#| output: true\n#| error: true\nspainok <- left_join(spain, inflationOK_df, by = \"iso2.ccaa.code\")\n\n```\n### 4. Creating the map-chart with the inflation information\n\n**Last step it is more easy, start to draw**\n\nIt is very important to declare the numeric variable that we want to \"paint\". \nIn our case it is \"Total\".\n\n```{r}\n#| eval: true\n#| output: true\n#| error: true\nggplot() + geom_sf(data=spainok, aes(fill = Total)) + \n  scale_fill_continuous(low=\"yellow\",high=\"red\") +\n  geom_sf(data = esp_get_can_box(), colour = \"grey50\")\n```\n\n\nFull site with more examples and vignettes on https://ropenspain.github.io/mapSpain/\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css"],"toc":true,"highlight-style":"a11y","output-file":"index.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.269","theme":"flatly","title-block-banner":true,"title":"Create map-charts using mapSpain","author":"Adrian Manzanal","date":"2023-11-21","categories":["news","code","analysis","geolocalitation"],"image":"logo.png"},"extensions":{"book":{"multiFile":true}}}}}