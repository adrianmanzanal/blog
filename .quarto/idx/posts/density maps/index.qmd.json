{"title":"Road to density maps creation","markdown":{"yaml":{"title":"Road to density maps creation","author":"Adrian Manzanal","date":"2023-11-31","categories":["news","maps","density functions"],"image":"title2.jpg"},"headingText":"**Lets paint your density maps using R**","containsRefs":false,"markdown":"\n\n**Different ways to create density maps**\n\nIt would be useful to prepare these libraries for next steps..\n\n```{r}\n#| eval: true\n#| output: false\n#| error: false\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(mapSpain)\nlibrary(ggmap)\nlibrary(sf)\nlibrary(ggplot2)\nlibrary(climaemet)\nlibrary(stars)\nlibrary(gstat)\n```\n\nSometimes datasets are not geolocated in a similar way. There are some areas crowed of data and other areas with no data.\nIn order to explain how to calculate the estimated information for these \"empty\" areas we are going to start using AEMET temperatures data by day and weather station:\n\n```{r}\n#| eval: true\n#| output: true\n#| error: false\n#| echo: false\n \n \n #Seleccionamos una fecha del histórico\n fecha_select <- \"2023-11-01\"\n \n #conseguimos los datos diarios de cada estación para esa fecha\n clim_data <- aemet_daily_clim(\n   start = fecha_select, end = fecha_select,\n   return_sf = TRUE\n )\n \n #quitamos las Canarias para simplificar\n clim_data_clean <- clim_data  |> \n   filter(!provincia %in% c(\"LAS PALMAS\", \"STA. CRUZ DE TENERIFE\"))  |> \n   dplyr::select(fecha, tmin)  |> \n   filter(!is.na(tmin))\n \n #conseguimos el mapa de la Península\n esp_sf <- esp_get_ccaa(epsg = 4326) |> \n   filter(ine.ccaa.name != \"Canarias\") \n \nggplot() +\n  geom_sf(data = esp_sf) +\n  geom_sf(fill = \"white\") +\n  geom_sf(data = clim_data_clean, color = \"#EE9322\") +\n  theme_void() +\n  labs(\n    title = \"Estaciones de la Aemet\",\n    subtitle = \"2023\"\n  ) +\n  theme(\n    plot.title = element_text(size = 21, face = \"bold\", hjust = 0.5),\n    plot.subtitle = element_text(size = 18, hjust = 0.5)\n  )\n```\n\n*To learn how to connect to \"climaemet\" package please see the previous post \"Handle climatic data using AEMET API\".*\n\n\n### 1. Extract clima data and Spain SF map.\n\n```{r}\n#| eval: false\n#| output: false\n#| error: false\n#| echo: true\n \n \n #Historical Date\n fecha_select <- \"2023-11-01\"\n \n #Extract clima data for this day:\n clim_data <- aemet_daily_clim(\n   start = fecha_select, end = fecha_select,\n   return_sf = TRUE\n )\n \n #Select min temperatures and remove Canary Islands:\n clim_data_clean <- clim_data  |> \n   filter(!provincia %in% c(\"LAS PALMAS\", \"STA. CRUZ DE TENERIFE\"))  |> \n   dplyr::select(fecha, tmin)  |> \n   filter(!is.na(tmin))\n \n #From mapSpain we download the SF:\n esp_sf <- esp_get_ccaa(epsg = 4326) |> \n   filter(ine.ccaa.name != \"Canarias\") \n```\n\n### 2. Create the GRID to interpolate/estimate data.\n\nTo interpolate data between weather stations it is important to create a grill. In order to adjust the same number of spaces we divided Spain area by small cells (10km)\n\n\n```{r}\n#| eval: true\n#| output: true\n#| error: false\n#| echo: true\n\nmapa.sf <- st_as_sf(esp_sf, coords = geometry) # Spain map has been selected to be converted to SF\n\n\nst_bbox(mapa.sf) %>% \n  st_as_stars(mapa.sf = 10000) %>% # Using Spain SF object we are going to create 10 km cells grill.\nst_crop(mapa.sf) -> grd \n\nplot(grd, main=\"GRID\", col=\"cadetblue3\", breaks=\"equal\")\n\n```\n\n\n### 3. First interpolation Approach: Thiessen Polynomials.\n\nThis methodological approach allows us to create areas for this data point. These calculated areas are equivalent distributed depending the distance between each of the original points.\n\n\n```{r}\n#| eval: true\n#| output: true\n#| error: false\n#| echo: true\n\nthiessen <- krige(tmin ~ 1, clim_data_clean, grd, nmax = 1)\nplot(thiessen)\n\n\nggplot() +\n  geom_stars(data = thiessen, aes(fill = var1.pred, x = x, y = y)) +\n  geom_sf(data = st_cast(esp_sf, \"MULTILINESTRING\")) +\n  geom_sf(data = clim_data_clean, color = \"#EE9322\") +\n  scale_fill_gradientn(colours = sf.colors(20), na.value=NA) +\n  theme_void() +\n  labs(\n    title = \"Minimal Temperatures\",\n    subtitle = \"December 2023\"\n  ) +\ntheme_void()\n\n```  \n\n### 4. IDW Interpolation\n\n```{r}\n#| eval: true\n#| output: true\n#| error: false\n#| echo: true\ni = idw(tmin ~ 1, clim_data_clean, grd)\n  ## [inverse distance weighted interpolation]\nggplot() + geom_stars(data = i, aes(fill = var1.pred, x = x, y = y)) + # IDW Prediction\n  geom_sf(data = st_cast(mapa.sf, \"MULTILINESTRING\")) + # Spain map shape\n  xlab(\"Longitud\") + ylab(\"Latitud\") + # Axis names\n  labs(\n    title = \"Minimal Temperatures\",\n    subtitle = \"December 2023\"\n  )  + # Title\n  scale_fill_gradientn(colours = sf.colors(20), na.value=NA)+ # Colours\n  theme_void() \n\n```  \n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css"],"toc":true,"highlight-style":"a11y","output-file":"index.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.269","theme":"flatly","title-block-banner":true,"title":"Road to density maps creation","author":"Adrian Manzanal","date":"2023-11-31","categories":["news","maps","density functions"],"image":"title2.jpg"},"extensions":{"book":{"multiFile":true}}}}}