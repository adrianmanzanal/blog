{"title":"Bucket a numeric vector into n groups, quantiles","markdown":{"yaml":{"title":"Bucket a numeric vector into n groups, quantiles","author":"Adrian Manzanal","date":"2024-05-05","categories":["statistics","frequency distribution"],"image":"cuantilesicon.jpg"},"headingText":"**Quantiles in R**","containsRefs":false,"markdown":"\n\n**Helpful information in order to know non-central distribution measures**\n\nThe word “quantile” comes from the word quantity. In simple terms, a quantile is where a sample is divided into equal-sized, adjacent, subgroups (that’s why it’s sometimes called a “fractile“). It can also refer to dividing a probability distribution into areas of equal probability.\n\nUsing non-central measures, as quantile, we will be able to analyze the income distribution for the different poblational groups.\n\nFull site with examples and vignettes on https://dplyr.tidyverse.org/reference/ntile.html.\n\n### Identify the variable that you are interested in\n\nFirst of all, you should select the variable which will be used to segregate. In this example we are going to use the following:\n\n$$\nAvailable Income per Household (HY020). \n$$\nWe are using the ECV sample, from the INE (Instituto Nacional de Estadística)\n\nIt would be useful to prepare the following packages..\n\n```{r}\n#| eval: true\n#| output: false\n#| error: false\nlibrary(dplyr)\nlibrary(ggplot2)\n```\n\n```{r}\n#| eval: true\n#| output: false\n#| error: false\n#| echo: false\nlibrary(kableExtra)\n```\n\nNow we start reading the raw data in csv format:\n\n```{r}\n#| eval: true\n#| output: false\n#| error: false\ndata_hog_2023 <- read.csv(\"./esudb23h.csv\")\n\n```\n\nBefore start with the segregation, would be very useful to analyze the entire poblation. If we look at the main statistics:\n\n```{r}\n#| eval: true\n#| output: true\n#| error: false\n#| echo: false\n\nmediana_hogar2023_0 <- data_hog_2023 %>%\n  mutate(counting = 1) %>%\n  summarise(mediana_renta = median (HY020), media_renta = mean(HY020), muestra =  sum(counting)) %>%\n  ungroup() \n\n```\n\n\n```{r}\n#| eval: true\n#| output: true\n#| error: false\n#| echo: false\n\nkbl(mediana_hogar2023_0)\n\n```\n\nand if we look at the histogram:\n```{r}\n#| eval: true\n#| output: true\n#| error: false\n#| echo: false\n\nggplot(data = data_hog_2023) + \n  geom_histogram(aes(x=HY020), binwidth = 100, fill = \"indianred1\")\n\n```\n\n\n\n\n### How to create quantiles\n\nntile() is a sort of very rough rank, which breaks the input vector into n buckets. If length(x) is not an integer multiple of n, the size of the buckets will differ by up to one, with larger buckets coming first.\n\nUnlike other ranking functions, ntile() ignores ties: it will create evenly sized buckets even if the same value of x ends up in different buckets.\n\n```{r}\n#| eval: true\n#| output: false\n#| error: false\ndata_hogar2023_v2 <- data_hog_2023 %>%\n  mutate(counting = 1) %>%\n  filter(HY020 >=0 ) %>%\n  mutate(decil = ntile(HY020, n = 10),\n         cuartil = ntile(HY020, n = 4)\n  ) %>%\n  select(c(\"HB120\", \"HY020\", \"HY023\", \"HY040N\", \"HY090N\", \"HS011\", \"HS021\", \"HH021\", \"HX240\", \"vhPobreza\", \n           \"counting\", \"decil\", \"cuartil\", \"HY040G\"))\n```\n\nIn order to calculate the thresholds of each interval:\n\n```{r}\n#| eval: true\n#| output: true\n#| error: false\n#| echo: true\n\ncuartiles_hog <- quantile(data_hogar2023_v2$HY020, probs = seq(0, 1, by = 0.25))\n\nplot(cuartiles_hog, type = \"b\", xlab = \"Decil\", ylab = \"Renta\", main = \"Cuartiles Intervals\")\nkbl(cuartiles_hog)\n```\n\n### Analyzing quantiles\n\nQuantiles are useful measures because they are less susceptible than means to long-tailed distributions and outliers. Empirically, if the data being analyzed are not actually distributed according to an assumed distribution, or if there are other potential sources for outliers that are far removed from the mean, then quantiles may be more useful descriptive statistics than means and other moment-related statistics.\n\nIn our case we are very interested to know the income distribution for the different poblational groups. Before start any cluster project you must analyze your poblation using quantiles.\n\nThere is more dispersion in the 4th quantil:\n\n\n```{r cuartilstat, fig.width=10, fig.height = 5, echo=TRUE}\nboxplot(data_hogar2023_v2$HY020 ~ data_hogar2023_v2$cuartil, main=\"Income Distribution 2023\", \n        xlab = \"cuartiles\", ylab = \"Available Net Income per Household\") \n```\n\nWhen we analyze the main statistic indicators for each quantil, there are an important difference between the groups in terms of average income, specially in the last quantil:\n\n```{r cuartilstat2, fig.width=10, fig.height = 5, echo=TRUE}\nkbl(estadisticos_cuartil_hog<- data_hogar2023_v2 %>%\n  group_by(cuartil) %>%\n  summarise(muestra = sum(counting), media_renta = mean(HY020), mediana_renta = median(HY020),\n            media_rentas_capital = mean(HY090N), media_rentas_propiedad = mean(HY040N))\n)\n```\n\nIt is very interesting to see how capital and real state incomes increase in importance in the 4th quantil.\n\nFurthermore, we can segregate the original histogram by quantil:\n\n\n```{r cuartilstat3, echo=FALSE, error=FALSE, warning=FALSE}\ndata_hogar2023_v2  %>%\n  ggplot (aes(x = HY020, group = cuartil), binwidth = 30) +\n  geom_histogram(bins=30) +\n  facet_wrap(~ cuartil) +\n  labs(x = \"Available Income\", y = \"Observations\") +\n  ggtitle(\"Histograms 2023\")\n```\n\n### Quantiles and other variables\n\n\n```{r calculations3, include=FALSE}\ncaseros_df23 <- data_hogar2023_v2 %>%\n  mutate(casero = ifelse(HY040G>0, \"Percibe rentas Propiedad\",\"No percibe rentas de propiedad\")) %>%\n  group_by(cuartil, casero) %>%\n  summarise(sum(counting)) \n\n```\n\n```{r cuartilstat6, echo=TRUE, error=FALSE, warning=FALSE, fig.width=10, fig.height = 5}\nggplot(data= caseros_df23, aes(x=cuartil, y=caseros_df23$`sum(counting)`, fill=as.character(casero))) +\n  geom_bar(stat = \"identity\") +\n  geom_text(aes(label=caseros_df23$`sum(counting)`), vjust=1, color=\"white\",\n             size=5) +\n    ggtitle(\"Real Estate Owners\")\n```"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css"],"toc":true,"highlight-style":"a11y","output-file":"index.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.269","theme":"flatly","title-block-banner":true,"title":"Bucket a numeric vector into n groups, quantiles","author":"Adrian Manzanal","date":"2024-05-05","categories":["statistics","frequency distribution"],"image":"cuantilesicon.jpg"},"extensions":{"book":{"multiFile":true}}}}}